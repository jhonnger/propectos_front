<app-navbar></app-navbar>

<div class="dashboard-container">
  <!-- Header Section -->
  <div class="dashboard-header">
    <div class="header-content">
      <div class="header-left">
        <div class="header-icon-wrapper">
          <mat-icon>dashboard</mat-icon>
        </div>
        <div>
          <h1 class="page-title">Mis Prospectos</h1>
          <p class="page-subtitle">Gestiona tus prospectos asignados</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Metrics Cards -->
  <div class="metrics-section">
    <div class="metric-card">
      <div class="metric-icon-bg sin-gestionar-bg">
        <mat-icon>hourglass_empty</mat-icon>
      </div>
      <div class="metric-content">
        <span class="metric-value">{{ stats.sinGestionar }}</span>
        <span class="metric-label">Sin Gestionar</span>
      </div>
    </div>

    <div class="metric-card">
      <div class="metric-icon-bg en-gestion-bg">
        <mat-icon>phone_in_talk</mat-icon>
      </div>
      <div class="metric-content">
        <span class="metric-value">{{ stats.enGestion }}</span>
        <span class="metric-label">En Gestion</span>
      </div>
    </div>

    <div class="metric-card">
      <div class="metric-icon-bg agendados-bg">
        <mat-icon>event</mat-icon>
      </div>
      <div class="metric-content">
        <span class="metric-value">{{ stats.agendados }}</span>
        <span class="metric-label">Agendados</span>
      </div>
    </div>

    <div class="metric-card">
      <div class="metric-icon-bg finalizados-bg">
        <mat-icon>check_circle</mat-icon>
      </div>
      <div class="metric-content">
        <span class="metric-value">{{ stats.finalizados }}</span>
        <span class="metric-label">Finalizados</span>
      </div>
    </div>
  </div>

  <!-- Filter Chips -->
  <div class="filter-section">
    <button class="filter-chip" [class.filter-active]="isFilterActive(null, null)" (click)="setFiltro(null, null)">
      Todos
    </button>
    <button class="filter-chip" [class.filter-active]="isFilterActive('SIN_GESTIONAR', null)" (click)="setFiltro('SIN_GESTIONAR', null)">
      <mat-icon>hourglass_empty</mat-icon> Sin gestionar
    </button>
    <button class="filter-chip" [class.filter-active]="isFilterActive(null, 'NO_CONTESTO')" (click)="setFiltro(null, 'NO_CONTESTO')">
      <mat-icon>phone_missed</mat-icon> No contesto
    </button>
    <button class="filter-chip" [class.filter-active]="isFilterActive(null, 'AGENDADO')" (click)="setFiltro(null, 'AGENDADO')">
      <mat-icon>event</mat-icon> Agendados
    </button>
    <button class="filter-chip" [class.filter-active]="isFilterActive(null, 'PROSPECTO')" (click)="setFiltro(null, 'PROSPECTO')">
      <mat-icon>star</mat-icon> Prospectos
    </button>
    <button class="filter-chip" [class.filter-active]="isFilterActive(null, 'OBSERVADO')" (click)="setFiltro(null, 'OBSERVADO')">
      <mat-icon>visibility</mat-icon> Observados
    </button>
    <button class="filter-chip" [class.filter-active]="isFilterActive('FINALIZADO', null)" (click)="setFiltro('FINALIZADO', null)">
      <mat-icon>done_all</mat-icon> Finalizados
    </button>
  </div>

  <!-- Table Section -->
  <div class="table-section">
    <div class="section-header">
      <div class="section-title-group">
        <mat-icon class="section-icon">people</mat-icon>
        <div>
          <h2 class="section-title">Prospectos Asignados</h2>
          <p class="section-subtitle">{{ totalResultados }} prospectos en total</p>
        </div>
      </div>
      <div class="section-actions">
        <button mat-stroked-button class="export-btn" (click)="exportarExcel()">
          <mat-icon>download</mat-icon>
          Exportar
        </button>
        <button mat-stroked-button class="refresh-btn" (click)="buscar(); loadStats()">
          <mat-icon>refresh</mat-icon>
          Actualizar
        </button>
      </div>
    </div>

    <!-- Desktop Table View -->
    <div class="table-container desktop-only">
      <table mat-table [dataSource]="dataSource" class="prospects-table">

        <!-- Nombre Column -->
        <ng-container matColumnDef="nombre">
          <th mat-header-cell *matHeaderCellDef>Nombre Completo</th>
          <td mat-cell *matCellDef="let prospect">
            <div class="prospect-name-cell">
              <div class="prospect-avatar">{{ (prospect.nombre?.charAt(0) || '') + (prospect.apellido?.charAt(0) || '') }}</div>
              <div class="prospect-name-info">
                <span class="name-primary">{{ prospect.nombre }} {{ prospect.apellido }}</span>
                <span class="name-secondary">{{ prospect.documentoIdentidad }}</span>
              </div>
            </div>
          </td>
        </ng-container>

        <!-- Campana Column -->
        <ng-container matColumnDef="campania">
          <th mat-header-cell *matHeaderCellDef>Campana</th>
          <td mat-cell *matCellDef="let prospect">
            <span class="campaign-badge">
              <span class="campaign-dot"></span>
              {{ prospect.campania }}
            </span>
          </td>
        </ng-container>

        <!-- Celular Column -->
        <ng-container matColumnDef="celular">
          <th mat-header-cell *matHeaderCellDef>Telefono</th>
          <td mat-cell *matCellDef="let prospect">
            <a href="tel:{{ prospect.celular }}" class="phone-link">
              <mat-icon class="phone-icon">phone</mat-icon>
              {{ prospect.celular }}
            </a>
          </td>
        </ng-container>

        <!-- Estado Column -->
        <ng-container matColumnDef="estado">
          <th mat-header-cell *matHeaderCellDef>Estado</th>
          <td mat-cell *matCellDef="let prospect">
            <span class="estado-badge" [class]="getEstadoResultadoClass(prospect.estadoResultado)">
              <mat-icon class="estado-badge-icon">{{ getEstadoResultadoIcon(prospect.estadoResultado) }}</mat-icon>
              {{ getEstadoResultadoText(prospect.estadoResultado) }}
            </span>
            <div class="fecha-agenda" *ngIf="prospect.estadoResultado === 'AGENDADO' && prospect.fechaAgenda"
                 [class.agenda-hoy]="isAgendaHoy(prospect)">
              <mat-icon *ngIf="isAgendaHoy(prospect)" class="agenda-hoy-icon">notifications_active</mat-icon>
              {{ prospect.fechaAgenda | date: 'dd/MM HH:mm' }}
              <span *ngIf="isAgendaHoy(prospect)" class="agenda-hoy-label">HOY</span>
            </div>
          </td>
        </ng-container>

        <!-- Contactos Column -->
        <ng-container matColumnDef="contactos">
          <th mat-header-cell *matHeaderCellDef>Gestiones</th>
          <td mat-cell *matCellDef="let prospect">
            <div class="contactos-cell">
              <span class="contactos-count">{{ prospect.totalContactos }}</span>
              <span class="contactos-label" *ngIf="prospect.ultimoContacto">
                {{ prospect.ultimoContacto | date: 'dd/MM HH:mm' }}
              </span>
            </div>
          </td>
        </ng-container>

        <!-- Actions Column -->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Acciones</th>
          <td mat-cell *matCellDef="let prospect">
            <button
              mat-flat-button
              class="action-btn"
              [class.action-btn-disabled]="isFinalizado(prospect)"
              (click)="openDialog(prospect)"
              [disabled]="isFinalizado(prospect)"
              matTooltip="{{ isFinalizado(prospect) ? 'Prospecto finalizado' : 'Registrar contacto' }}">
              <mat-icon>{{ isFinalizado(prospect) ? 'lock' : 'edit_note' }}</mat-icon>
              {{ isFinalizado(prospect) ? 'Cerrado' : 'Gestionar' }}
            </button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;" class="table-row"></tr>
      </table>

      <!-- Empty State Desktop -->
      <div class="empty-state" *ngIf="prospects.length === 0">
        <mat-icon class="empty-icon">inbox</mat-icon>
        <h3>No hay prospectos disponibles</h3>
        <p>Los prospectos apareceran aqui cuando sean asignados</p>
      </div>
    </div>

    <!-- Mobile Cards View -->
    <div class="mobile-cards-container mobile-only">
      <div class="prospect-card" *ngFor="let prospect of prospects">
        <div class="card-header">
          <div class="card-header-left">
            <div class="prospect-avatar mobile-avatar">{{ (prospect.nombre.charAt(0) || '') + (prospect.apellido.charAt(0) || '') }}</div>
            <div class="prospect-info">
              <h3 class="prospect-name-mobile">{{ prospect.nombre }} {{ prospect.apellido }}</h3>
              <span class="prospect-dni">DNI: {{ prospect.documentoIdentidad }}</span>
            </div>
          </div>
          <span class="estado-badge mobile-estado" [class]="getEstadoResultadoClass(prospect.estadoResultado)">
            <mat-icon class="estado-badge-icon">{{ getEstadoResultadoIcon(prospect.estadoResultado) }}</mat-icon>
            {{ getEstadoResultadoText(prospect.estadoResultado) }}
          </span>
        </div>

        <div class="card-content">
          <div class="info-row">
            <div class="info-label-group">
              <mat-icon class="info-row-icon">phone</mat-icon>
              <span class="info-label">Telefono</span>
            </div>
            <a href="tel:{{ prospect.celular }}" class="phone-link-mobile">{{ prospect.celular }}</a>
          </div>

          <div class="info-row">
            <div class="info-label-group">
              <mat-icon class="info-row-icon">campaign</mat-icon>
              <span class="info-label">Campana</span>
            </div>
            <span class="campaign-badge-mobile">{{ prospect.campania }}</span>
          </div>

          <div class="info-row">
            <div class="info-label-group">
              <mat-icon class="info-row-icon">history</mat-icon>
              <span class="info-label">Gestiones</span>
            </div>
            <span>{{ prospect.totalContactos }}</span>
          </div>

          <button
            mat-flat-button
            class="action-btn mobile-action-btn"
            [class.action-btn-disabled]="isFinalizado(prospect)"
            (click)="openDialog(prospect)"
            [disabled]="isFinalizado(prospect)">
            <mat-icon>{{ isFinalizado(prospect) ? 'lock' : 'edit_note' }}</mat-icon>
            {{ isFinalizado(prospect) ? 'Cerrado' : 'Gestionar' }}
          </button>
        </div>
      </div>

      <!-- Empty State Mobile -->
      <div class="empty-state" *ngIf="prospects.length === 0">
        <mat-icon class="empty-icon">inbox</mat-icon>
        <h3>No hay prospectos disponibles</h3>
        <p>Los prospectos apareceran aqui cuando sean asignados</p>
      </div>
    </div>

    <!-- Pagination -->
    <div class="pagination-container" *ngIf="totalResultados > 0">
      <mat-paginator
        [length]="totalResultados"
        [pageSize]="tamanioPagina"
        [pageSizeOptions]="[5, 10, 20, 50]"
        (page)="onPageEvent($event)"
        showFirstLastButtons
        class="custom-paginator">
      </mat-paginator>
    </div>
  </div>
</div>
